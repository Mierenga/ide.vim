#!/bin/bash
################################################################################
# This script generates a new ide.vim file, which is loaded with vim and
# contains the vim interface for this plugin
################################################################################
# Argument for the project path to set as the current active project:
PROJECT_PATH=$1
# Path to this plugin's directory:
PLUGIN_PATH=~/.vim/plugin/ide
# Path to the configuration this file will generate
PLUGINVIMRC=$PLUGIN_PATH/ide.vim
# Path to the keymap definition used to generate the keymaps
KEYMAPCONFIG=$PLUGIN_PATH/keys.config
# Path the static functions that need to be loaded 
# in the plugin configuration
STATICFUNCTIONS=$PLUGIN_PATH/static.functions
################################################################################
# Load the key map configuration
# (source of variables $KEY_* below)
. $KEYMAPCONFIG
################################################################################
# write a header to the configuration file that displays 
# the active project path
clear_and_write_header() {
    echo \"--------------------------------------------------------------------\
        > $PLUGINVIMRC
    echo \" ***this file is auto-generated by the SwitchProject command***\
        >> $PLUGINVIMRC
    echo \" active project: $PROJECT_PATH >> $PLUGINVIMRC
    echo \"--------------------------------------------------------------------\
        >> $PLUGINVIMRC
    echo >> $PLUGINVIMRC
}
# ensure the plugin configuration loads the static functions
write_source_static_functions() {
    echo ":source $STATICFUNCTIONS" >> $PLUGINVIMRC
}
# utility to write a custom keymap for a make target
# to the plugin configuration
write_keymap_make_target() {
    echo -n "nmap "$1" :!make " >> $PLUGINVIMRC
    echo -n "--file $PROJECT_PATH"/Makefile "$2" >> $PLUGINVIMRC
    echo " <CR><CR>" >> $PLUGINVIMRC
}
# main function to generate a new configuration
write_ide_vimrc() {
    clear_and_write_header
    write_source_static_functions
    write_keymap_make_target $KEY_RUN run
    write_keymap_make_target $KEY_KILL kill
    write_keymap_make_target $KEY_TEST test
}
# execute
################################################################################
write_ide_vimrc
################################################################################
